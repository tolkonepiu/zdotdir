name: Zsh Benchmark

"on":
  pull_request:
  push:
    branches:
      - main
    paths-ignore:
      - .gitignore
      - .github/**

permissions:
  # Required to post benchmark results as comments on pull requests
  pull-requests: write
  # deployments permission to deploy GitHub pages website
  deployments: write
  # contents permission to update benchmark contents in gh-pages branch
  contents: write

jobs:
  benchmark:
    runs-on: ${{ matrix.os }}
    strategy:
      max-parallel: 1
      fail-fast: true
      matrix:
        include:
          # - os: macos-latest
          #   name: macOS
          #   install: |
          #     brew update
          #     brew install zsh
          - os: ubuntu-latest
            name: Ubuntu
            install: |
              sudo apt update
              sudo apt install -y zsh libtinfo-dev

    steps:
      - name: ⤵️ Check out code
        uses: actions/checkout@v3

      - name: Install dependencies
        run: ${{ matrix.install }}

      - name: 🏗️ Set Zsh environment (ZDOTDIR)
        run: |
          ZDOTDIR=~/.config/zsh
          ln -s $GITHUB_WORKSPACE $ZDOTDIR
          echo ". $ZDOTDIR/.zshenv" > ~/.zshenv

      - name: Fix insecure directories for Zsh
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo chmod -R go-w /usr/share/zsh /usr/share/zsh/vendor-completions

      - name: 🏗️ Change default shell to Zsh
        run: sudo chsh -s $(which zsh) $(whoami)

      - name: 🏗️ Init Zsh environment
        run: |
          zsh --version
          echo "SHELL is set to: $SHELL"
          echo "ZDOTDIR is set to: $ZDOTDIR"
          zmodload -m | grep zsh

          if ! zmodload zsh/datetime; then
            print -ru2 "zsh/datetime not available"
          fi

          if ! zmodload zsh/system; then
            print -ru2 "zsh/system not available"
          fi

          if ! zmodload zsh/zselect; then
            print -ru2 "zsh/zselect not available"
          fi
        shell: zsh -li --rcs {0}

      - name: 🚀 Run Zsh Benchmark
        run: zsh ./.github/scripts/zsh-benchmark.zsh
        env:
          BENCHMARK_RESULT: benchmark-result.json

      - name: 📥 Upload Benchmark Results
        uses: benchmark-action/github-action-benchmark@v1
        with:
          name: ${{ matrix.name }}
          tool: customSmallerIsBetter
          output-file-path: benchmark-result.json
          github-token: ${{ secrets.GITHUB_TOKEN }}
          auto-push: ${{ github.event_name == 'push' }}
          comment-on-alert: ${{ github.event_name == 'pull_request' }}
          fail-on-alert: false
